+++
title = "PostgreSQL"
author = ["Hrishikesh Barman"]
draft = false
+++

tags
: [Database]({{< relref "20221102123145-database.md" >}})


## EXPLAIN {#explain}

{{< figure src="/ox-hugo/20221102123302-postgresql-1354143187.png" >}}


## Features {#features}


### Temporary Tables {#temporary-tables}

-   Implemented like regular tables, but uses `temp_buffers` and uses disk for storing metadata and overflows etc.
-   Unlike regular tables, not guaranteed to be used by multiple connections at the same time, are not subject to locks, are not written to WAL, etc.
-   Located in PostgreSQL system tables. In addition, for each table, one or more files are created on disk (by default, in the same folder as the files for regular tables).
-   Allows different sessions to use the same temporary table name for different purposes
-   Automatically dropped at the end of a session, or optionally at the end of the current transaction based on `ON COMMIT`


#### Issues {#issues}

-   Autovacuum daemon cannot access and therefore cannot vacuum or analyze temporary tables.
-   Need to be purged
    -   `DELETE ALL` bad cuz MVCC is used for Temporary tables aswell and deleting records is slow  (See [Concurrency]({{< relref "20221126204257-concurrency.md" >}}))
    -   So we `TRUNCATE`: `TRUNCATE` simply creates a new file on disk and does an UPDATE of the `pg_class` table.


#### Read more {#read-more}

-   [PostgreSQL and Temporary Tables - DEV Community](https://dev.to/crushby/postgresql-and-temporary-tables-1ned)


### UPSERT {#upsert}

```sql
-- canonical
INSERT INTO table (col1, col2, col3)
VALUES (val1, val2, val3)
ON
 CONFLICT conflict_target conflict_action;
-- example
INSERT INTO employees (id, name, email)
VALUES (2, ‘Dennis’, ‘dennisp@weyland.corp’)
ON CONFLICT (id) DO UPDATE;
-- conflict_target: (id)
-- conflict_action: DO UPDATE
```


## Relevant Notes {#relevant-notes}

-   **Initializing a postgres directory:** After logging into the `postgres` user, you can create a directory with necessary postgres files with the `initdb` command. It creates a directory in the file system and then you can start a postgres server directing it to that directory.
-   **Tablespaces:** All tables are by default created in `pg_default` tablespace, creating in a tablespace does not affect the logical SQL schema.
-   **public schema:** All databases will have a public schema created by the `postgres` user. By default `\d` will be showing relations from the public schema.
-   In PostgreSQL, the Transaction Id is a 32-bit integer, and the VACUUM process is responsible (among other things like reclaiming old row versions that are no longer in use) for making sure that the id does not overflow.
    -   For this reason, you should never disable the VACUUM as transaction wraparound can lean to catastrophic situations.
    -   See MMVC in [Concurrency]({{< relref "20221126204257-concurrency.md" >}})


## Cluster {#cluster}

-   When do we need a cluster vs db??


## Replication {#replication}

See [Data Replication]({{< relref "20231021151742-data_replication.md" >}})


## Tools {#tools}


### Routing {#routing}

-   <https://github.com/pgbouncer/pgbouncer>
    -   [Prepared Statements in Transaction Mode for PgBouncer](https://www.crunchydata.com/blog/prepared-statements-in-transaction-mode-for-pgbouncer#how-much-faster-are-prepared-statements)


### Others {#others}

-   [Ways to capture changes in Postgres | Hacker News](https://news.ycombinator.com/item?id=37610899)
-   <https://github.com/zalando/patroni>
-   <https://github.com/pganalyze/libpg_query>
-   <https://github.com/wal-g/wal-g>
-   <https://github.com/pgbackrest/pgbackrest>
-   <https://github.com/cybertec-postgresql/pgwatch2>
-   <https://github.com/citusdata/pg_cron>
-   <https://github.com/cybertec-postgresql/pg_timetable>


### Extension {#extension}

-   [Pg_jsonschema – JSON Schema Support for Postgres | Hacker News](https://news.ycombinator.com/item?id=35258323)
-   [pgvector: Embeddings and vector similarity | Supabase Docs](https://supabase.com/docs/guides/database/extensions/pgvector)


## Links {#links}

-   [Types of Indexes in PostgreSQL](https://www.highgo.ca/2020/06/22/types-of-indexes-in-postgresql/)
-   <https://twitter.com/samokhvalov/status/1713094683159941508>
-   <https://twitter.com/samokhvalov/status/1713094683159941508>
-   <https://twitter.com/samokhvalov/status/1702812327261950130>
-   [Explain Guide](https://www.pgmustard.com/docs/explain)
-   <https://github.com/allaboutapps/integresql>
-   [Five Tips For a Healthier Postgres Database in the New Year](https://www.crunchydata.com/blog/five-tips-for-a-healthier-postgres-database-in-the-new-year)
-   [Making PostgreSQL tick: New features in pg_cron | Hacker News](https://news.ycombinator.com/item?id=38029671)
-   [Show HN: Light implementation of Event Sourcing using PostgreSQL as event store | Hacker News](https://news.ycombinator.com/item?id=38084098)
-   [Postgres WAL Files and Sequence Numbers](https://www.crunchydata.com/blog/postgres-wal-files-and-sequuence-numbers)
-   [Postgres schema changes are still a PITA | Lobsters](https://lobste.rs/s/ze70h7/postgres_schema_changes_are_still_pita)


### Other comments {#other-comments}


#### tw1 {#tw1}

Some PostgreSQL footguns:

-   default configuration
-   long transactions mixed with OLTP workload
-   repmgr (and other HA tools not based on consensus algorithms)
-   LISTEN/NOTIFY
-   "pg_dump is a utility for backing up a PostgreSQL database" says the official doc
-   moving/copying PGDATA and ignoring glibc version change
-   hot_standby_feedback on/off dilemma
-   partitioning of tables having high number of indexes and receiving QPS &gt;&gt; 1k
-   "setting statement_timeout in postgresql.conf is not recommended because it would affect all sessions" says the official doc
-   using replication slots w/o setting max_slot_wal_keep_size
-   relying only on statement_timeout &amp; idle_in_transaction_session_timeout and thinking it's enough (lack of transaction_timeout)
-   data types "money", "enum", "timestamp" (3 different cases)
-   int4 PK
-   massive DELETE
-   attempts to use transactional version of DDL (e.g., CREATE INDEX) under heavy loads
-   subtransactions
-   DDL under load without lock_timeout
