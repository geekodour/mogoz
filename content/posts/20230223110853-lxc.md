+++
title = "LXC & LXD"
author = ["Hrishikesh Barman"]
draft = false
+++

tags
: [Containers]({{< relref "20230218104617-containers.md" >}})


## LXC {#lxc}

-   LXC Images : [Linux Containers - Image server](https://uk.lxd.images.canonical.com/)
-   OS level virtualization for running multiple isolated containers on single Linux kernel.
-   Introduced 2008
-   Lowlevel
-   Usually managed via manager like LXD
-   LXC is because it doesn't support OCI.


## LXD {#lxd}


### Intro {#intro}

-   LXD is built on top of LXC and aims to provide a better user experience. Basically a management system on top of LXC.
-   It implements a single REST API for both local and remote access.
-   Scales from one instance on a single machine to a cluster in a full data center rack

LXD consists of two parts:

-   Daemon (the `lxd` binary)
-   Client (the `lxc` binary)


### Confusion w LXC {#confusion-w-lxc}

<div class="warning small-text">

> `lxc` is not `LXC`; the naming is a bit confusing.
>
> -   `lxc` is the `lxd` client
> -   All `lxc-*` commands are low level LXC commands
</div>


### Setting up LXD {#setting-up-lxd}

-   Daemon
    -   Anyone belonging to the `lxd` group will have access to the daemon.
    -   LXD daemon can be accessed locally over a Unix socket or, if configured, remotely over a TLS socket.
-   User
    -   LXD loads the subuid/subgid values from /etc on startup.
-   Config &amp; Profile
    -   Everytime you `lxd init`, config gets overwritten, you can use `--preseed` to provide config via file.
    -   For the bare minimum, you need to set a storage pool and network bridge.
    -   Once the network bridge is setup, it'll show up in `ip addr`
    -   See [Instance options - LXD documentation](https://linuxcontainers.org/lxd/docs/master/reference/instance_options/#instance-options-security)
-   Others
    -   You can run docker inside LXD by setting `security.nesting`


### Instances {#instances}


#### Containers {#containers}

Implemented through the use of `liblxc` (LXC).

-   System container
    -   Simulates a virtual version of a full operating system.
    -   Uses kernel running on the host system.
    -   Suitable for full solution of libraries, applications, databases etc.
    -   Can create different user spaces and isolate all processes belonging to each user space
-   Application container
    -   These are more in the likes of what Docker provides
    -   Usually packages a single process or application.
    -   Suitable to provide separate components


#### VMs {#vms}

-   Uses `qemu` to provide the VM functionality.
-   Uses the hardware of the host system
-   Uses kernel provided by the virtual machine.
-   Can be used to run a different operating system.


### Privileged and Unprivileged containers {#privileged-and-unprivileged-containers}

-   LXD by default is unprivileged
    -   Default map: 65536 UIDs and GIDs, w host base id of 100000.
    -   container `root` (`uid0`) : mapped to host uid 100000
    -   container (`uid65535`) : mapped to host uid 165535


### `subuid` and `subgid` {#subuid-and-subgid}

-   `sub(uid/gid)` ranges for the users `lxd` &amp; `root` to be kept in sync.
    -   The `lxd` entry in `subuid/subgid` tracks what needs to be removed if LXD is uninstalled.
        -   TODO: Confirm if this is still the case?
-   **NOTE:** Systems w older `shadow`, lxd assumes upto 1bn ids.


#### Usage {#usage}

-   Change the size of the default map
    ```shell
        $ cat /etc/subuid
        lxd:100000:65536
        root:100000:65536

        $ cat /etc/subgid
        lxd:100000:65536
        root:100000:65536
    ```
-   Per container maps
    -   Need to alter kernel resource [ulimits]({{< relref "20230225145310-ulimits.md" >}})
    -   No data sharing between containers: `security.idmap.isolated`
        ```shell
        lxc config set <instance> security.idmap.isolated true # no sharing btwn containers
        lxc config set <instance> security.idmap.size 200000 # change alloc size
        # if allocation > allocated to lxd itself, will throw error
        ```
-   Access host but not other containers
    -   In unprivileged containers, usually user will be mapped to a user that doesn't exist on `host` = no storage sharing w host


### LXC configuration for LXD TODO {#lxc-configuration-for-lxd-todo}

```cfg
# file: /etc/lxc/default.conf
lxc.net.0.type = empty
lxc.idmap = u 0 1000 65536
lxc.idmap = g 0 1000 65536
```

```shell
# doing this downsides but I am okay with it
usermod -a -G lxd username
```
