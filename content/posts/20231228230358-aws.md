+++
title = "AWS"
author = ["Hrishikesh Barman"]
draft = false
+++

tags
: [Infrastructure]({{< relref "20221101183735-infrastructure.md" >}}), [Containers]({{< relref "20230218104617-containers.md" >}}), [Kubernetes]({{< relref "20221102125748-kubernetes.md" >}}), [Terraform]({{< relref "20231229022230-terraform.md" >}})


## FAQ {#faq}


### EBS what? {#ebs-what}

-   EBS can be confusing
-   Elastic Beanstalk (EB)
-   Elastic Block Storage (EBS)
-   Proper use is EB and EBS


### Security services in AWS? {#security-services-in-aws}

See [Cloud cryptography demystified: Amazon Web Services | Trail of Bits Blog](https://blog.trailofbits.com/2024/02/14/cloud-cryptography-demystified-amazon-web-services/)


### Deploying containers on AWS {#deploying-containers-on-aws}

-   See [Containers on AWS](https://containersonaws.com/)
-   See [17 More Ways to Run Containers on AWS](https://archive.is/H2F9k)
-   See [Concurrency Compared: Lambda, App Runner, AWS Fargate](https://nathanpeck.com/concurrency-compared-lambda-fargate-app-runner/)
-   `K8s on EC2 / EKS`: Extremely robust, scalable, and need tight controls over your containers.
-   `Docker Swarm on EC2`: Simple orchestration but still want to manage it.
-   `ECS on EC2`: Ease of use and want access to your hosts
-   `ECS on Fargate`: Never think about anything other than the container
-   `Plain EC2 with docker/docker-compose`: This is where you manually install docker and docker-compose on EC2. You can do this but I'd prefer using ECS with EC2 instead.
-   `EC2+Beanstalk+Docker`: Can be done but pretty cumbersome.
-   `docker on lightsail`
-   `lightsail container service`
-   `Apprunner`


### Managed services? {#managed-services}

-   See [Shared Responsibility Model - Amazon Web Services (AWS)](https://aws.amazon.com/compliance/shared-responsibility-model/)


### Spot Instances? {#spot-instances}

This allows running fault-tolerant workloads at a much cheaper price

-   EC2 Spot instances
-   Fargate Spot instances


### Things that cost you vs things that don't {#things-that-cost-you-vs-things-that-don-t}

| Thing                                            | Costs?                                                                                               | Description |
|--------------------------------------------------|------------------------------------------------------------------------------------------------------|-------------|
| IGW                                              | [NO](https://www.reddit.com/r/aws/comments/940ncc/are_there_costs_associated_to_internet_gateway/)   |             |
| Cross AZ NAT traffic                             | Yes                                                                                                  |             |
| Cross AZ load balancing(ALB)                     | NO                                                                                                   |             |
| Cross AZ load balancing(NLB)                     | [Yes](https://aws.amazon.com/elasticloadbalancing/faqs/)                                             |             |
| Accessing public ALB from private subnet via NAT | [Yes](https://www.reddit.com/r/aws/comments/yuye2a/does_traffic_to_a_public_alb_go_via_nat_gateway/) |             |
| Accessing NAT gateway from different AZ          | [Yes](https://stackoverflow.com/questions/59525573/can-a-single-nat-gateway-span-across-multiple-az) |             |


## Concepts {#concepts}


### AMI {#ami}

-   Amazon Machine Image
-   pre-configured virtual machine image, used to create and launch instances within Amazon Elastic Compute Cloud (EC2).


### Roles &amp; Accounts &amp; Users {#roles-and-accounts-and-users}


#### IAM Roles {#iam-roles}

-   See [IAM (Identity and Access Management)]({{< relref "20231102172218-iam.md" >}})
-   See [AWS IAM Roles, a tale of unnecessary complexity | infosec.rodeo](https://infosec.rodeo/posts/thoughts-on-aws-iam/)
-   See [Introduction to AWS IAM AssumeRole | by Rouble Malik | AWS in Plain English](https://aws.plainenglish.io/introduction-to-aws-iam-assumerole-fbef3ce8e90b)
-   See [IAM JSON policy elements reference - AWS Identity and Access Management](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements.html)
-   See [How IAM works - AWS Identity and Access Management](https://docs.aws.amazon.com/IAM/latest/UserGuide/intro-structure.html)
-   Identity center and IAM relationship: [See this](https://www.reddit.com/r/aws/comments/14j4wmn/iam_or_iam_identity_center/)

<!--list-separator-->

-  AssumeRole and [Terraform]({{< relref "20231229022230-terraform.md" >}})

    -   See [Will Terraform Delete my Existing Infrastructure on AWS when Apply?](https://tanutaran.medium.com/will-terraform-delete-my-existing-infrastructure-on-aws-when-apply-0554176d1089)
        -   No
    -   [Using AWS AssumeRole with the AWS Terraform Provider – HashiCorp Help Center](https://support.hashicorp.com/hc/en-us/articles/360041289933-Using-AWS-AssumeRole-with-the-AWS-Terraform-Provider)
    -   [Use AssumeRole to provision AWS resources across accounts | Terraform | HashiCorp Developer](https://developer.hashicorp.com/terraform/tutorials/aws/aws-assumerole)
    -   [amazon web services - Execute Terraform apply with AWS assume role - Stack Overflow](https://stackoverflow.com/questions/55128348/execute-terraform-apply-with-aws-assume-role)
        -   This is the way^ ❇
        -   Also see [IAM tutorial: Delegate access across AWS accounts using IAM roles](https://docs.aws.amazon.com/IAM/latest/UserGuide/tutorial_cross-account-with-roles.html)

<!--list-separator-->

-  ARN


## Networking in AWS {#networking-in-aws}


### AZ {#az}


#### Regions vs Availability Zones {#regions-vs-availability-zones}

-   Region: `us-east-1`, `us-east-2`
-   AZ: `us-east-1a`, `us-east-1b`

![](/ox-hugo/20231228230358-aws-2091698512.png)
![](/ox-hugo/20231228230358-aws-1361153418.png)


#### AZ and Subnets {#az-and-subnets}

-   `1:N relation` (1(AZ):N(subnets))
-   Each subnet must reside entirely within one Availability Zone and cannot span zones.
-   Each AZ can have many subnets(public/private)


### IP address assigning {#ip-address-assigning}

-   [IP addressing for your VPCs and subnets - Amazon Virtual Private Cloud](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-ip-addressing.html#vpc-public-ipv4-addresses)
-   Everything has a private IP, when there's a public IP for something. The public IP is mapped to the private IP of that instance.
-   Can happen at a VPC level (??)
-   Can happen at the subnet level
    -   This is what is confused me. Having this setting enabled doesn't make a subnet public. There's a different definion of a public subnet
-   Can happen at the instance level
-   Also can be assigned via ElasticIP


### Subnets {#subnets}


#### Subnets in AWS(Cloud) vs Classical subnets {#subnets-in-aws--cloud--vs-classical-subnets}

While the idea of subnet is the same but the reason why we create subnets in classical [Networking]({{< relref "20221101143905-networking.md" >}}) and in AWS/cloud are different

-   In on-prem, we use subnet gateways typically to perform filtering, broadcast traffic and fault isolation etc. (L2 involved)
-   In could, there's no L2. In AWS, each subnet can route to other subnets within the VPC range(s). We can filter using NACL and SG.
-   Usecase in cloud of subnet are possibly the following
    -   Routing: If we need to separate traffic of IGW vs NGW vs VGW vs TGW etc. we need subnets as subnets will result in route tables
    -   HA: In AWS, subnets are related to AZ
    -   Traffic Filtering: If you want to use NACL, you'd need to create subnets


### <span class="org-todo todo TODO">TODO</span> Routing tables {#routing-tables}

-   See [Configure route tables](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Route_Tables.html) to understand route-tables.
-   There are different levels of route-tables
-   Subnets have route table (Private and Public subnets have their own route table)
-   Inter subnet communications
    -   Routing between subnets is handled internally within the VPC based on the routes defined in the associated route tables.


### VPC {#vpc}

See [Practical VPC Design](https://medium.com/aws-activate-startup-blog/practical-vpc-design-8412e1a18dcc) (Also has notes about Security Groups)
![](/ox-hugo/20231228230358-aws-420695806.png)
![](/ox-hugo/20231228230358-aws-1357513570.png)

-   By default, when you create a VPC, a main route table is created.
-   [Amazon VPC quotas](https://docs.aws.amazon.com/vpc/latest/userguide/amazon-vpc-limits.html)


#### Subnets {#subnets}

<!--list-separator-->

-  Subnets and AZ

    -   Subnets exist in exactly one AZ
    -   CIDRs for each subnet in a VPC cannot overlap

<!--list-separator-->

-  Public and Private

    <!--list-separator-->

    -  Public

        -   A subnet with the default route to the IGW
        -   IP assign
            -   Configure VPC to assign public addresses to instances
            -   Assign Elastic IP addresses to instances

    <!--list-separator-->

    -  Private

        -   A subnet with **NO** default route to the IGW
        -   **Instances in private subnet can't communicate with the internet over the IGW**
        -   Since instances in the private subnet will have private IPs, and IGW does not do NAT for private IPs, we just cannot do outbount/inbound. (But this is not the case w IPv6)

        <!--list-separator-->

        -  Internet access for instances in private subnet

            {{< figure src="/ox-hugo/20231228230358-aws-1112056219.png" >}}

            -   NAT instance/gateway in a public subnet
            -   0.0.0.0/0 in private subnet points to the NAT Gateway
            -   NAT gateway points to IGW


#### Default vs New VPC {#default-vs-new-vpc}

{{< figure src="/ox-hugo/20231228230358-aws-1170529805.png" >}}

-   Default VPC has functional advantage
-   A default VPC comes with a public subnet in each Availability Zone, an internet gateway, and settings to enable DNS resolution.


#### VPC and Gateways {#vpc-and-gateways}

-   AWS Gateways are things that are related to a VPC, not to subnets
-   VPC is just a LAN with local access until you stick an IGW on it.
    -   i.e a routing table entry allowing a subnet to access the IGW.
-   Whether or not traffic uses IGW or NGW depends on subnet's routing
    -   e.g. an instance w public EIP can go directly out the IGW
    -   e.g if we route `0.0.0.0/0` to the NAT GW for that instance's subnet, it would get NAT'ed to the NATGW.


#### DNS inside VPC {#dns-inside-vpc}

-   [DNS attributes for your VPC - Amazon Virtual Private Cloud](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-dns.html#vpc-private-hosted-zones)

<!--list-separator-->

-  Amazon DNS server

<!--list-separator-->

-  Private Hosted Zone

    Access the resources in your VPC using custom DNS domain names, such as example.com, instead of using private IPv4 addresses or AWS-provided private DNS hostnames,

    -   [Route 53 Private Hosted Zones across multiple Accounts : aws](https://www.reddit.com/r/aws/comments/15gpflq/route_53_private_hosted_zones_across_multiple/)
    -   [How to use Route53 for DNS resolution internally but Cloudflare externally? : aws](https://www.reddit.com/r/aws/comments/tbguu6/how_to_use_route53_for_dns_resolution_internally/)
    -   <https://community.cloudflare.com/t/delegating-sub-domains-to-aws-r53/8511>
    -   [domain name system - Cloudflare + AWS route 53 combined to handle records - Server Fault](https://serverfault.com/questions/847175/cloudflare-aws-route-53-combined-to-handle-records)
    -   [amazon web services - Can I use AWS route 53 and Cloudflare at the same time? - Stack Overflow](https://stackoverflow.com/questions/42972423/can-i-use-aws-route-53-and-cloudflare-at-the-same-time)
    -   [Considerations when working with a private hosted zone - Amazon Route 53](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/hosted-zone-private-considerations.html)


#### VPC Peering, AWS Privatelink and VPC Endpoints {#vpc-peering-aws-privatelink-and-vpc-endpoints}

-   `VPC Peering` is linking a VPC and is CIDR range to another so you need to be careful of ensuring different CIDR ranges.
-   `VPC Endpoints` are a way of connecting to managed services, without going to the public internet and back again.
    -   Usually you'd use AWS PrivateLink to implement VPC endpoints
    -   `AWS PrivateLink` is technology allowing you to privately (without Internet) access services in VPCs. These services can be your own, or provided by AWS.


### Gateway {#gateway}


#### Internet gateway (IGW, Twoway, Inbount&amp;Outbound) {#internet-gateway--igw-twoway-inbount-and-outbound}

-   Internet gateway routes public IPs `IN/OUT->TO THE INTERNET`
-   Does not do NAT for private subnets, for public subnet
    -   Logically provides the one-to-one NAT on behalf of your instance
    -   When traffic goes VPC to Internet, reply address is set to the public IPv4 address or EIP of instance
    -   When traffic comes Internet to EIP/PublicIPv4, destination address translated into the instance's private IPv4 address before the traffic is delivered to the VPC.
-   Two Way
    -   Allows resources within your public subnet to access the internet
    -   Allows the internet to access said resources in the public subnet.


#### NAT gateway (NGW, Oneway, Outbound) {#nat-gateway--ngw-oneway-outbound}

-   See [NAT]({{< relref "20221101190313-nat.md" >}})
-   Translates private IPs to it's public IP.
-   You cannot associate a security group with a NAT gateway. You can associate security groups with your instances to control inbound and outbound traffic.
-   A NAT gateway has to be defined in a public subnet
    -   Public NAT gateway is associated with One Elastic IP address which cannot be disassociated after its creation.
-   A nat gateway still uses IGW to get to the Internet.
-   One way
    -   private resources access the internet

<!--list-separator-->

-  Usecases

    -   Instances in private subnets talking to the internet
    -   Whitelisting IP: Making all outgoing traffic through a NAT Gateway(single IP) is useful when whitelisting IP addresses with external services. For this reason, it's useful to have a EIP for NAT Gateway, Eg. If you ever need to replace your NAT instance, you don't need to update the whitelist in other places because now you have [a EIP](https://stackoverflow.com/questions/43094786/why-does-a-aws-nat-gateway-require-an-elasticip) :)

<!--list-separator-->

-  NAT gateway vs NAT instance

    -   See [Compare NAT gateways and NAT instances](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-comparison.html)
    -   See <https://fck-nat.dev/stable/deploying/>
    -   They both perform the same action
    -   NAT instance is like EC2, no HA, Cheaper and tough to scale.
        -   You run NAT software on an EC2 and managing it.
    -   NAT gateway is HA plus scalable, hence costly. It’s a managed AWS service. You can’t SSH to NAT gateway and it’s very stable.
    -   So in a way, NAT instance is self managed NAT gateway


### IPv6 {#ipv6}


#### Concepts/Services {#concepts-services}

<!--list-separator-->

-  Dual stack

    <!--list-separator-->

    -  Dual stack VPC

        If it has CIDR blocks for IPv4 and IPv6

        <!--list-separator-->

        -  IPv6 CIDR Block

            {{< figure src="/ox-hugo/20231228230358-aws-1385004022.png" >}}

            -   Can be dual stack or IPv4 only

        <!--list-separator-->

        -  IPv6 Routing

            {{< figure src="/ox-hugo/20231228230358-aws-1407753816.png" >}}

            -   VPC has routing table, subnets can talk to each other

        <!--list-separator-->

        -  DNS

            {{< figure src="/ox-hugo/20231228230358-aws-2027511484.png" >}}

            -   Each VPC has its own DNS resolver(route53 resolver), tied to the region's `Route53`
            -   DNS resolver has both IPv4&amp;IPv6 addresses
            -   Each EC2 instance can send 1024 packets per second per network interface to Route 53 Resolver (.2 address)

        <!--list-separator-->

        -  Subnet Types and traffic flow

            -   Dual stack (Eg. migrating existing subnet to IPv6)
            -   IPv4 only (Eg. existing subnet)
            -   IPv6 only
            -   All of these subnet types can co-exist in a VPC

            ![](/ox-hugo/20231228230358-aws-511193303.png)
            ![](/ox-hugo/20231228230358-aws-1266595211.png)

            <!--list-separator-->

            -  How will a IPv6 only EC2 instance talk to a IPv4 subnet?

                -   Do we run IPv4 &amp; IPv6 in parallel? Backwards compatibility

    <!--list-separator-->

    -  Dual stack ELB

<!--list-separator-->

-  IP management

    {{< figure src="/ox-hugo/20231228230358-aws-950384955.png" >}}

    <!--list-separator-->

    -  Hierarchy and Organization

        ![](/ox-hugo/20231228230358-aws-1099800499.png)
        ![](/ox-hugo/20231228230358-aws-119919914.png)
        We want things like easy summarization and good structure and hierarchy in our subnets.

        -   Example CIDR hierarchy: `Top level pool > regions > routing domains/environments > VPCs > Subnets`
        -   AWS by default assigns us a random CIDR for IPv6. (From the Amazon pool). Instead we create our own pool so that we can manage things ourselves
            -   Eg. For each `region` I am going to assign this CIDR block and then from that block I'll start allocating CIDRs to the VPCs.

    <!--list-separator-->

    -  IPAM

        IPAM allows you to manage IP address across multiple accounts/regions

<!--list-separator-->

-  IPv6 IP assigning

    -   `/56` : For VPC (Fixed length) (Number of vpc is limited, 5 non-overlapping VPC ranges.)
    -   `/64` : For Subnets inside the VPC (Fixed length) (Number of subnet is limited)
        -   Network identifier and host identifier can be 64bit each

<!--list-separator-->

-  Internet Connectivity

    <!--list-separator-->

    -  IPv6 to IPv6

        {{< figure src="/ox-hugo/20231228230358-aws-683029595.png" >}}

        -   IPv6 addresses with the EC2 instance in a public subnet in a VPC would be a global unicast address.
        -   So we would not need NAT there, It can directly talk throught the IGW.

    <!--list-separator-->

    - <span class="org-todo todo TODO">TODO</span>  IPv6 to IPv4

        -   Using DNS64 and NAT64
        -   See [IPv6 Addressing &amp; Architecture: AWS - YouTube](https://www.youtube.com/watch?v=qnKP9uRPe98&t=542s)

        {{< figure src="/ox-hugo/20231228230358-aws-1655495727.png" >}}

    <!--list-separator-->

    -  IPv6 in a Private subnet

        {{< figure src="/ox-hugo/20231228230358-aws-1623567785.png" >}}

        -   The IPv6 address is globally unicast
        -   So if we put a instance which is in a subnet(which we consider private) but has a set the gateway to the internet gateway, we're exposing it bi-directonal to the internet.
        -   Because unlike IPv4 private networks they can just use the internet without NAT.
        -   Solution is to use [egress only IGW](https://repost.aws/knowledge-center/configure-private-ipv6-subnet)


#### Usecases {#usecases}

<!--list-separator-->

-  Network

    {{< figure src="/ox-hugo/20231228230358-aws-231279922.png" >}}

    -   Aquition: oVerlapping ipv4 addresses!
        -   Solution
            -   Dual stack VPC &amp; IPv6 only subnets
            -   Dual stack internal network routing
                -   We have VPC2VPC methods that allow us to access internal ipv6 network
                -   VPC2VPC
                    -   AWS Transist Gateway
                    -   Cloud1
                    -   Hybrid connectivity w VPN
                    -   Direct connect

<!--list-separator-->

-  Services &amp; Businesses

    -   Exposing services on
        -   On AWS network
        -   On Public internet
    -   Now the business wants to serve clients who are connecting to it using ipv6 (In places w greater ipv6 adoption)
        -   Dual stack VPC (Network level) + Dual stack ELB (Service level)


## Operations {#operations}


### Load Balancers {#load-balancers}


#### AWS offerings {#aws-offerings}

<!--list-separator-->

-  ELB / CLB (Not recommended)

    -   Elastic [Load Balancers]({{< relref "20230215194922-load_balancers.md" >}})
    -   aka CLB (Classic LB)
    -   Did both L4 and L7 load balancing
    -   Lot [of limitations](https://iamondemand.com/blog/elb-vs-alb-vs-nlb-choosing-the-best-aws-load-balancer-for-your-needs/), ALB and NLB are newer.

<!--list-separator-->

-  ALB (L7)

    {{< figure src="/ox-hugo/20231228230358-aws-356652645.png" >}}

    -   Primary purpose of alb is to split traffic for the `same route` between `different backends`.
    -   Also rule based routing. (AWS API Gateway(AGW) only does this)

<!--list-separator-->

-  NLB (L4)


#### [reverse proxies]({{< relref "20230212101521-proxies.md" >}}) vs [Load Balancers]({{< relref "20230215194922-load_balancers.md" >}})? {#reverse-proxies--20230212101521-proxies-dot-md--vs-load-balancers--20230215194922-load-balancers-dot-md}

Options are either of:

-   NLB + nginx/traefik/caddy etc
-   ALB + LB controller(if using [Kubernetes]({{< relref "20221102125748-kubernetes.md" >}}))

Additionally:

-   We can still use a reverse proxy + ALB, but that's [usually not necessary.](https://www.reddit.com/r/aws/comments/f5ttaj/ideal_setup_of_ecs_cluster_with_traefik_and_alb/)
    -   [Traefik Proxy in AWS with AWS ECS - Part 1 — Compose-X Labs documentation](https://labs.compose-x.io/apps/traefik_ecs_part1.html)
    -   [Traefik AWS ECS Documentation - Traefik](https://doc.traefik.io/traefik/providers/ecs/)
-   For ECS anywhere an [external load balancer](https://aws.amazon.com/blogs/containers/implementing-application-load-balancing-of-amazon-ecs-anywhere-workloads-using-traefik-proxy/) may be useful.


#### Target Groups {#target-groups}

<!--list-separator-->

-  Registering &amp; Deregistering

    -   When registering, ensure that you have appropriate security groups that allow `LB-instance inbound` communication.
    -   When deregister a target, the load balancer waits until in-flight requests have completed.

<!--list-separator-->

-  Targets types

    > This can be different for different kind of LB

    -   `instance-id` (picks ip-address from the instance)
        -   `ASG(AutoScalingGroup)`: This helps with the fact that you no longer now need to manually add/remove targets from the TargetGroup as application load increases/decreases. This happens via [Amazon EC2 Auto Scaling](https://docs.aws.amazon.com/autoscaling/ec2/userguide/attach-load-balancer-asg.html), it automates that manual add/remove of instances from the target group by selecting an `exiting LB` and `exiting TG`
    -   `ip` (from valid CIDR block)
    -   `lambda`

<!--list-separator-->

-  Mapping

    -   `N:N` mapping, N(TG):N(Targets)
        -   There can be multiple TG
        -   A target can be associated with multiple TG
    -   `1:N` mapping, 1(LB):N(TG)
        -   Each TG can be used with only one LB
        -   One LB can have multiple target groups


### ALB {#alb}


#### Troubleshoot/Info? {#troubleshoot-info}

-   [Network Traffic Distribution – Elastic Load Balancing FAQs – Amazon Web Services](https://aws.amazon.com/elasticloadbalancing/faqs/)
-   [Troubleshoot your Application Load Balancers - Elastic Load Balancing](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-troubleshooting.html#client-cannot-connect)
-   [Amazon ELB in VPC - Stack Overflow](https://stackoverflow.com/questions/9257514/amazon-elb-in-vpc)


#### What is an ALB really? {#what-is-an-alb-really}

-   2 things. The definition of the `LB(LB object)` and the actual `provisioned instances per AZ`.
-   As an AWS user, you only ever directly deal with the LB object(configuring etc).
-   Based on your configuration, it provisions the LB instances in respective AZ which do the actual load balancing.
    -   ALB instances serve targets in its AZ, or in cross-AZ/cross-VPC as-well if targets are there.
-   AZ and TG for an LB need to be in same VPC


#### Process of ALB creation {#process-of-alb-creation}

-   LB object =&gt; LB instances in AZ =&gt; LB instances in subnet =&gt; IP address assigned
-   DNS for both internal and ALB is publicly resolvable. Useful when you connect via [VPN]({{< relref "20230210192007-vpn.md" >}}).
-   Both `internet-facing` and `internal` load balancers route requests to your targets using private IP addresses. Therefore, targets don't need public IP to receive requests from an internal/internet-facing LB.

<!--list-separator-->

-  Internet facing ALB

    -   You define the LB object. (Two AZ)
    -   Since internet-facing, subnet that the AZ belong to will be `public` (route to IGW)
    -   It'll provision LB instance in the two AZ
    -   Create EIP with a public IP. This [IP can keep changing](https://repost.aws/questions/QUHNazu9Y5ThK5BUAkJLGVyA/why-does-elb-need-one-public-ip-address-for-each-public-subnet) so refer to ALB by DNS name.

<!--list-separator-->

-  Internal ALB

    -   You define the LB object. (Two AZ)
    -   Since internal, subnet that the AZ belong to will be `private` (no IGW)
    -   It'll provision LB instance in the two AZ
    -   A private IP will be assigned to the LB instance.


#### Placing an LB in a subnet and LB talking to targets {#placing-an-lb-in-a-subnet-and-lb-talking-to-targets}

-   You enable a AZ for a LB by placing the LB in that AZ, i.e placing the LB in one of the subnets of the AZ
-   Once it's placed in a subnet in an AZ, by virtue of VPC route tables, it'll be able to talk to all private/public subnets wherever the targets are.


#### What about capturing real client IP? {#what-about-capturing-real-client-ip}

See [Capture client IP addresses in the web server logs behind an ELB](https://repost.aws/knowledge-center/elb-capture-client-ip-addresses) &amp; [HTTP]({{< relref "20230222161545-http.md" >}})


#### How does ALB talk to clients(users) and targets? {#how-does-alb-talk-to-clients--users--and-targets}

-   See [How ELB works doc](https://docs.aws.amazon.com/elasticloadbalancing/latest/userguide/how-elastic-load-balancing-works.html)
-   Could use multiple HTTP based protocols for client communication, uses HTTP1.1 for target communcation
-   Both `internet-facing` and `internal` LB route requests to targets using `private IP addresses`


#### Usecase of internal ALB? {#usecase-of-internal-alb}

Usecase of external ALB is apparent, but folliwing are some usecases for internal ALB

-   Multi tier
    -   `internet-facing LB <-> Web-server(s)`
    -   `internal LB <-> Application-server(s)`
    -   Final: `internet-facing LB <-> Web-server(s) <-> internal LB <-> Application-server(s)`
    -   The web-server(s) can be looking up a DNS record which would point to the internal LB and then it can use Host headers etc.
-   Giving access to internal services in a VPC
    -   Suppose you want to host grafana/some other internal service in the VPC
    -   People can use some kind of [VPN]({{< relref "20230210192007-vpn.md" >}}) to access the VPC
    -   The internal LB can be handy here trying to give access to the various internal services to people using the VPN
-   Service Discovery (See [Infrastructure]({{< relref "20221101183735-infrastructure.md" >}}))
    -   While AWS [offers](https://aws.amazon.com/blogs/compute/task-networking-in-aws-fargate/) [various ways](https://docs.aws.amazon.com/AmazonECS/latest/bestpracticesguide/networking.html) to do service discovery, having an internal LB can also be a way to do the same.
        -   Cloudmap, ECS Service Connect, AppMesh, etc etc.
    -   `service A -> internal LB -> service B`


#### Connection establishment vs Traffic flow in ALB {#connection-establishment-vs-traffic-flow-in-alb}

<!--list-separator-->

-  Connection Establishment

    Following diagrams initially confused me, I confused direction of connection establishment to traffic flow.
    ![](/ox-hugo/20231228230358-aws-2001810422.png)
    ![](/ox-hugo/20231228230358-aws-1184418742.png)

<!--list-separator-->

-  Traffic flow

    {{< figure src="/ox-hugo/20231228230358-aws-987475309.png" >}}

    -   Traffic: `IGW <-> (ALB, Public subnet) <-> (Web Server, Private subnet)`
        -   [Reply traffic](https://stackoverflow.com/questions/59073361/is-elb-used-for-outbound-traffic) from the webserver will go though the ELB. It does not [need a NAT](https://stackoverflow.com/questions/56270410/how-do-packets-flow-when-i-have-a-elb-and-nat-gateway-in-a-public-subnet-that-d).
        -   ALB acts as a [TCP proxy here](https://serverfault.com/questions/726752/does-the-elb-also-route-outbound-reply-traffic-in-aws), establish a new TCP connection to the back-end server.
        -   Webserver will see incoming traffic from ALB's IP
    -   Only outgoing traffic purely originating from instances(Eg. `apt update`) in the private subnet need to go though the NAT gateway.
    -   See [Load balancer subnets and routing](https://docs.aws.amazon.com/prescriptive-guidance/latest/load-balancer-stickiness/subnets-routing.html) (Traffic flow)
    -   See [Receiving inbound connections from the internet](https://docs.aws.amazon.com/AmazonECS/latest/bestpracticesguide/networking-inbound.html)


#### Benefits of Cross-AZ load-balancing? {#benefits-of-cross-az-load-balancing}

For ALB, two AZ and cross AZ LB [must be enabled](https://docs.aws.amazon.com/elasticloadbalancing/latest/userguide/how-elastic-load-balancing-works.html)
![](/ox-hugo/20231228230358-aws-654520954.png)
![](/ox-hugo/20231228230358-aws-494954277.png)


#### Does ALB has to do anything with NAT Gateway? {#does-alb-has-to-do-anything-with-nat-gateway}

-   No. Both can operate independently as per need.
-   Usecase of both is different
-   Reply traffic goes though the ALB only, no NAT needed. Check the traffic flow question.


## <span class="org-todo todo TODO">TODO</span> Security in AWS {#security-in-aws}

-   [The AWS Security Reference Architecture - AWS Prescriptive Guidance](https://docs.aws.amazon.com/prescriptive-guidance/latest/security-reference-architecture/architecture.html)
-   [HIPAA on AWS—Solution](https://aws.amazon.com/solutions/implementations/compliance-hipaa/)


### Certificates {#certificates}

-   ACM certificate by region


### SG {#sg}

-   security groups can be used to control networking access by only allowing inbound traffic from other known security groups that you add to the allow list. (Verify??)


### NACL vs Security Groups {#nacl-vs-security-groups}

If we want defense in depth, we want to be using both

|             | NACL                                                      | SG                               |
|-------------|-----------------------------------------------------------|----------------------------------|
| Stateful?   | Stateless (Return traffic needs to be explicitly allowed) | Stateful                         |
| Rules       | Both allow and Deny                                       | Allow only                       |
| Association | Subnets(1:N mapping, `1(NACL):N(subnet)`)                 | Network Interface, Instance(EC2) |

Also see

-   [Security groups for your Application Load Balancer - Elastic Load Balancing](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-update-security-groups.html)
-   <https://www.reddit.com/r/aws/comments/8d5bdy/in_my_company_all_application_servers_for/>


### Storing application secrets {#storing-application-secrets}

-   [Secrets Manager vs Parameter Store](https://www.reddit.com/r/aws/comments/mk4wai/should_i_use_secrets_manager_or_ssm_parameter/)


## Services {#services}


### EC2 {#ec2}

-   `Security Groups` are the [Firewalls]({{< relref "20230306125249-firewalls.md" >}}) of EC2


### ECS {#ecs}

-   A [Container]({{< relref "20230218104617-containers.md" >}}) orchestration tool/layer
-   We can have multiple ECS clusters
-   Alternative: [Kubernetes]({{< relref "20221102125748-kubernetes.md" >}}), Docker Swarm
-   Is free, You pay for the underlying host(ec2/fargate)
-   ECS will allow you to deploy a wide variety of containers on a number of instances and automatically handles the complexity of container placement and lifecycle for you. This is useful compared to using docker-compose on your ec2 instance.
-   Handles Services&amp;Task Definitions


#### Additional notes {#additional-notes}

-   ECS can integrate with other AWS services like load balancers, but they leave that completely up to you. It'll just orchestrate your stuff. Unlike EBS it'll not put a loadbalancer etc for you.
-   Passing runtime configurations for images as it doesn't have ConfigMaps like [Kubernetes]({{< relref "20221102125748-kubernetes.md" >}})
    -   SSM parameters like [this image](https://hub.docker.com/r/rdkls/kong_ssm/)
    -   [init container + s3](https://github.com/aws-samples/amazon-ecs-configmaps-example/blob/main/README.md)


#### Flavors {#flavors}

-   ECS on EC2
    -   EC2 instance need to install the ECS agent/AMI
    -   Resources in EC2 might be over-provisioned if the container does not use most of it
    -   You can also have it manage ASGs of your own EC2 instances
-   ECS on Fargate
    -   Managed
    -   If we configure properly only the resources needed for the container will be used.
    -   Uses Firecracker (See [Virtualization]({{< relref "20221101183016-virtualization.md" >}}), [Containers]({{< relref "20230218104617-containers.md" >}}), [OCI Ecosystem]({{< relref "20230603000641-oci_ecosystem.md" >}}))


### Elastic Beanstalk (EBS) {#elastic-beanstalk--ebs}

-   Beanstalk is a Platform as a Service (PaaS) offering
-   Puts the application in a autoscaling group by default?
-   Also will deploy a load-balancer.
-   It spins up a few opinionated services under the covers for you in an attempt to make deploying your application easier. (may not be desirable)
-   It's like heroku from AWS


### Elastic Block Storage (EBS) vs Elastic File System (EFS) {#elastic-block-storage--ebs--vs-elastic-file-system--efs}


### Lightsail {#lightsail}

See [Compare Amazon EC2 and Amazon Lightsail | AWS re:Post](https://repost.aws/knowledge-center/lightsail-differences-from-ec2)

-   Easiest way to run a virtual machine on AWS.
-   Good if you simply want to host simple one-off webapps/custom code etc.
-   Has restrictions on features and capabilities versus ec2.
-   Has a lightsail specific loadbalancer
-   No autoscaling
-   Network
    -   Managed by AWS
    -   No concept of private subnet
    -   w EC2 user gets to configure the VPC.


#### Lightsail container services {#lightsail-container-services}

-   This is priced different offering than lightsail instances but falls under the lightsail umbrella.
-   It's very simplified container deployment, image url and port, that's all.
-   Under the hood, ECS power lightsail container services.


### AppRunner {#apprunner}


### Cloudfront {#cloudfront}

CDN


### API gateway (AGW) {#api-gateway--agw}

-   See [CORS]({{< relref "20230302210256-cors.md" >}}), alternative could be selfhosting something like Kong
-   API gateway's primary purpose is rule based routing.
-   Once you get beyond a low number of requests, it becomes a lot more expensive than an ALB,
-   Features
    -   Rate Limiting
    -   Authorizers
    -   B/G Deployments


#### CDN/Cloudfront infront of API Gateway? {#cdn-cloudfront-infront-of-api-gateway}

Useful for couple of reasons:

-   Caching: Even if API gateway may have its own caching, could be expensive
-   Clients will connect to the nearest point of contact
-   HTTPS ([TLS]({{< relref "20230210181907-tls.md" >}})) negotiations happens in the nearest point reducing latency


### ACM (AWS Certificate Manager) {#acm--aws-certificate-manager}


## Cloudwatch {#cloudwatch}


### Period {#period}

Period is a query level thing

-   Metrics stored with
    -   Standard resolution: Can be retrieved with `period` of multiple of 60s
    -   High resolution: Can be retrieved with `period` of 1s, 5s, 10s, 30s, multiple of 60s
-   If you try querying standard resolution metric(1m) with a `period` of 30s, you cannot get granularity at that level. You'll get the same data as 1m.
-   On the other hand, you can query 1m resolution metrics at higher period like 5m. In the case of a 5 minute period, the single data point is placed at the beginning of the 5 minute time window. In the case of a 1 minute period, the single data point is placed at the 1 minute mark. So the graph for the same looks different.
-   Higher granularity period + higher granularity resolution, Good for
-   Analogy
    -   Resolution: photo resolution (Eg. mega pixels)
    -   Period: Zoom level on the photo when viewing it
    -   Dynamic time period when viewing graph: Panning on the image


### Resolution {#resolution}

| Resolution Type | Granularity/Resolution | Example                             |
|-----------------|------------------------|-------------------------------------|
| Standard        | 1m                     | AWS service metrics, Custom metrics |
| High Resolution | 1s (&lt;60s)           | Custom metrics                      |


### Metric Type (Related to ingestion) {#metric-type--related-to-ingestion}

-   Basic monitoring (Ingestion 5m)
-   Detailed monitoring (Ingestion &lt;5m)


### Metric Retention &amp; Rollups {#metric-retention-and-rollups}

| Resolution | Retention | Notes           |
|------------|-----------|-----------------|
| &lt;60s    | 3h        | high-resolution |
| 1m         | 15d       |                 |
| 5m         | 63d       |                 |
| 1h         | 15mo      |                 |

-   CW stores data of terminated instances as-well
-   CW metrics have automatic roll up. i.e Data points that are initially published with a shorter period are aggregated together for long-term storage.
    -   Eg.
        -   We collecting data with 1m resolution
        -   Till 15d: 1m resolution, can retrieve with resolution of 1m
        -   After 15d: Aggregated, can retrieve only with resolution of 5m
        -   After 63d: Aggregated, can retrieve only with resolution of 1h


## Links and Resources {#links-and-resources}


### AWS builder library {#aws-builder-library}

-   [ ] Most relevant
    -   [ ] [Building dashboards for operational visibility | Amazon Builders' Library](https://aws.amazon.com/builders-library/building-dashboards-for-operational-visibility/?did=ba_card&trk=ba_card)
    -   [ ] [Instrumenting distributed systems for operational visibility](https://aws.amazon.com/builders-library/instrumenting-distributed-systems-for-operational-visibility/?did=ba_card&trk=ba_card)
    -   [ ] [Going faster with continuous delivery](https://aws.amazon.com/builders-library/going-faster-with-continuous-delivery/?did=ba_card&trk=ba_card)
    -   [ ] [My CI/CD pipeline is my release captain](https://aws.amazon.com/builders-library/cicd-pipeline/)
-   [ ] Semi relevant
    -   [ ] [Implementing health checks](https://aws.amazon.com/builders-library/implementing-health-checks/?did=ba_card&trk=ba_card)
    -   [ ] [Leader election in distributed systems](https://aws.amazon.com/builders-library/leader-election-in-distributed-systems/?did=ba_card&trk=ba_card)
-   [ ] Less relevant
    -   [ ] [Timeouts, retries and backoff with jitter](https://aws.amazon.com/builders-library/timeouts-retries-and-backoff-with-jitter/?did=ba_card&trk=ba_card)
    -   [ ] [Challenges with distributed systems](https://aws.amazon.com/builders-library/challenges-with-distributed-systems/?did=ba_card&trk=ba_card)
    -   [ ] [Avoiding fallback in distributed systems](https://aws.amazon.com/builders-library/avoiding-fallback-in-distributed-systems/?did=ba_card&trk=ba_card)
    -   [ ] [Static stability using Availability Zones](https://aws.amazon.com/builders-library/static-stability-using-availability-zones/?did=ba_card&trk=ba_card)
    -   [ ] [Caching challenges and strategies](https://aws.amazon.com/builders-library/caching-challenges-and-strategies/?did=ba_card&trk=ba_card)
    -   [ ] [Automating safe, hands-off deployments](https://aws.amazon.com/builders-library/automating-safe-hands-off-deployments/?did=ba_card&trk=ba_card)
    -   [ ] [Avoiding overload in distributed systems by putting the smaller service in control](https://aws.amazon.com/builders-library/avoiding-overload-in-distributed-systems-by-putting-the-smaller-service-in-control/?did=ba_card&trk=ba_card)
    -   [ ] [Making retries safe with idempotent APIs](https://aws.amazon.com/builders-library/making-retries-safe-with-idempotent-APIs/?did=ba_card&trk=ba_card)
    -   [ ] [Minimizing correlated failures in distributed systems](https://aws.amazon.com/builders-library/minimizing-correlated-failures-in-distributed-systems/?did=ba_card&trk=ba_card)
    -   [ ] [Using dependency isolation to contain concurrency overload](https://aws.amazon.com/builders-library/dependency-isolation/)
    -   [ ] [Avoiding insurmountable queue backlogs](https://aws.amazon.com/builders-library/avoiding-insurmountable-queue-backlogs/?did=ba_card&trk=ba_card)
    -   [ ] [Using load shedding to avoid overload](https://aws.amazon.com/builders-library/using-load-shedding-to-avoid-overload/?did=ba_card&trk=ba_card)


### DevTools {#devtools}

-   <https://github.com/aws/amazon-ecs-cli>
-   <https://github.com/aws/copilot-cli>
-   <https://github.com/aws/aws-cli>
-   <https://github.com/jassics/awesome-aws-security>
-   <https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html>
-   <https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/eb-cli3-install.html>
