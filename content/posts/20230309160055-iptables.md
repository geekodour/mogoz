+++
title = "iptables"
author = ["Hrishikesh Barman"]
draft = false
+++

tags
: [Linux]({{< relref "20221101150211-linux.md" >}})


## Flow {#flow}

![](/ox-hugo/20230309160055-iptables-280672872.png)
See [this](https://www.frozentux.net/iptables-tutorial/iptables-tutorial.html#TRAVERSINGOFTABLES) for explanation.


### Packet {#packet}

-   **All interfaces are handled the same way**
-   Every IP packet that comes in on any network interface passes through this^ flow chart from top to bottom.
-   Internal interfaces are handled the same way internet facing interfaces are handled.


## Tables(5) {#tables--5}

`filters` are organized in different `tables`, which contain `chains of rules` for how to treat network traffic packets. Following are tables ordered by normal user usage frequency.

-   **filter**: Control the flow of packets in and out of a system. **Default table**. Firewall related.
-   **nat**: Redirect connections to other interfaces on the network and natting, port forwarding etc.
-   **mangle**: Modify packet headers/specialized packet alterations.
-   **raw**: Only for configuring packets so that they are exempt from connection tracking.
-   **security**: Mandatory Access Control networking rules (e.g. SELinux usage).


## Chains {#chains}

Lists of rules which are followed in order.

Eg. `Chain1 = [rule1, rule2, rule3, rule4]`

Chains can be builtin or user defined.

<div class="warning small-text">

> Pretty annoying that the definition of the builtin chains differ by table they are used for
</div>


### Basic idea of chains {#basic-idea-of-chains}

-   `INPUT` : Protect local applications from receiving unwanted network traffic
-   `OUTPUT` : Protect local applications sending undesired network traffic
-   `FORWARD` : Filter network traffic forwarded/routed by a Linux system


### Built in chains {#built-in-chains}

-   **filter**
    -   `INPUT` : for packets destined to local sockets
    -   `OUTPUT` : for locally-generated packets
    -   `FORWARD` : for packets being routed through the box
-   **nat**
    -   `INPUT` : for altering packets destined for local sockets
    -   `OUTPUT` : for altering locally-generated packets before routing
    -   `PREROUTING` : for altering packets  as  soon as they come in
    -   `POSTROUTING` : for altering packets as they are about to go out
-   **mangle**
    -   `INPUT` : for packets coming into the box itself
    -   `OUTPUT` : for altering locally-generated packets before routing
    -   `PREROUTING` : for altering incoming packets  before  routing
    -   `POSTROUTING` : for altering packets as they are about to go out
    -   `FORWARD` : for altering packets being routed through the box
-   **raw**
    -   `PREROUTING`: for packets arriving via any network interface
    -   `OUTPUT`: for packets generated by local processes
-   **security**
    -   `INPUT`: for packets coming into the box itself
    -   `OUTPUT`: for altering locally-generated packets before routing
    -   `FORWARD`: for altering packets being routed through the box


### Rules {#rules}

Rule refers to an action to be configured within a chain.

-   Rule = Match(s) + Target/Action
-   **Only built in chains have a default policy**. Generally set to `ACCEPT`, can be changed to `DROP`. Packet has to pass through all existing rules in chain before the default policy is applied.


#### Targets {#targets}

-   **All targets are not valid in all tables**
-   Specified by `-j` / `--jump`
-   Targets are either terminating (as built-in targets) or non-terminating (as user-defined chains). Target exts. can be any.
-   Can be
    -   User defined `chain`
    -   Builtin targets(`ACCEPT`, `DROP`, `QUEUE`, `RETURN`)
    -   Target extensions(`REJECT`, `LOG`, many more see `man iptables-extensions`).


### Traversing Chain {#traversing-chain}

-   1st routing decision: Decide if the final destination of is the local machine (`INPUT` chains) or elsewhere (`FORWARD` chains).
-   Subsequent routing decisions: Decide what interface to assign to an outgoing packet.
-   Chain -&gt; Rule(Evaluate)
    -   **If Match**: Execute target/jump action
        -   If target `DROP` : Packet is dropped and no further processing is done.
        -   If target `ACCEPT` : No traverse any further rules/chain of the table. Processing will jump to the first chain of the next table in order.
    -   **If No Match**: Packet is dropped back into the calling chain


## Resources {#resources}

-   [Drop versus Reject](https://www.chiark.greenend.org.uk/~peterb/network/drop-vs-reject)
-   <https://www.frozentux.net/iptables-tutorial/iptables-tutorial.html>
