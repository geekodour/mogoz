+++
title = "Golang"
author = ["Hrishikesh Barman"]
draft = false
+++

tags
: [Programming Languages]({{< relref "20221101220306-programming_languages.md" >}})


## Install, package management and building {#install-package-management-and-building}


### Installation {#installation}

-   Do not want ~/go
    ```shell
    export GOPATH=~/Projects/go
    ```


### Packages {#packages}


#### Proxy {#proxy}

-   What's the lag between pushing to github and go install $name@latest getting the latest commit?
-   go uses a proxy, That proxy regularly updates from the original repository
-   try `GOPROXY=direct` go install $name@latest
-   <https://goproxy.io/>
-   <https://proxy.golang.org/>


#### Standard Library {#standard-library}

-   You can find these in the go source tree
-   See [Standard library - Go Packages](https://pkg.go.dev/std)


#### Subrepos {#subrepos}

-   Things inside `/x`
-   Packages are part of the Go Project but outside the main Go tree.
-   See [Sub-repositories - Go Packages](https://pkg.go.dev/golang.org/x)


### Syscalls {#syscalls}


#### How does go make syscalls? {#how-does-go-make-syscalls}

-   Differs by Operating [system](https://groups.google.com/g/golang-nuts/c/uX8eUeyuuAY)
-   In Linux, because it has a [stable ABI](https://stackoverflow.com/questions/55735864/how-does-go-make-system-calls), it makes the syscalls directly skipping `libc`.
-   Enabling or disabling `CGO` has nothing to do with whether or not go syscall goes via `libc`, the C code used via `CGO` ofcourse will use `libc`.
-   Go does create wrappers around some syscalls (TODO: Need to dig into this)
-   Support for different syscalls in different OS is incremental. Eg. If `X` syscall is available in OS `A` and `B`. Go might have support for `X` only in `A` as of the moment.


#### Places where go handles syscalls {#places-where-go-handles-syscalls}

-   Try `fd syscall -t` on the go source tree.
-   [/syscall](https://pkg.go.dev/syscall@go1.20.2) : Frozen, except for changes needed to maintain the core repository.
-   [/internal/syscall](https://pkg.go.dev/internal/syscall@go1.20.2) : internal
-   [/runtime/internal/syscall](https://pkg.go.dev/runtime/internal/syscall) : internal, [some details](https://utcc.utoronto.ca/~cks/space/blog/programming/GoSchedulerAndSyscalls)
-   [/x/sys](https://pkg.go.dev/golang.org/x/sys)
    -   This is where new stuff goes and should be used by callers
    -   Contains 3 packages to hold their syscall implementations(Unix, Windows and Plan 9)
    -   Has the wrapper creation libraries such as [mkwinsyscall.go](https://cs.opensource.google/go/x/sys/+/refs/tags/v0.6.0:windows/mkwinsyscall/mkwinsyscall.go) and [mksyscall.go](https://cs.opensource.google/go/x/sys/+/refs/tags/v0.6.0:unix/mksyscall.go)


### Portability {#portability}

-   syscalls are not portable by nature, they are specific to the system. We need to add a build tag for the ARCH and OS that syscall invocation is valid for.


### Dynamic and Static Linking {#dynamic-and-static-linking}

-   What about user and net packages?


### CGO {#cgo}


#### Using CGO {#using-cgo}

-   Essentially utilising C api calls to shared libraries exporting C interface

<!--listend-->

```shell
CGO_ENABLED=1 CC=musl-gcc go build --ldflags '-linkmode external -extldflags=-static'
```


#### Without using CGO {#without-using-cgo}

-   Many times that a go binary, even if it has no cgo or cgo dependencies, will randomly require glibc on the target system to execute if you don't explicitly disable cgo in your build. `CGO_ENABLED=0`
-   [GitHub - ebitengine/purego](https://github.com/ebitengine/purego)
-   [Introducing wazero from Tetrate - Tetrate](https://tetrate.io/blog/introducing-wazero-from-tetrate/?hss_channel=tw-998918265177952259)


### Cross Compilation {#cross-compilation}


#### General cross compilation ideas {#general-cross-compilation-ideas}

-   Cross compiler: Compiler capable of creating executable code for a platform other than the one on which the compiler is running on.
-   Levels (one or many)
    -   Differing architecture (for MIPS on x86)
    -   Different vendors (most of the time `unknown`)
    -   Differing operating system (for FreeBSD on Linux)
    -   Differing system library/ABI (for msul libc while using glibc in the system)
-   `sysroot`: Directory which is considered to be the root directory for the purpose of locating headers and libraries.
-   `toolchain`: The set of compiler, linker, shared libs, any tools needed to produce the executable for the target.


#### Cross compilation in Golang {#cross-compilation-in-golang}

-   Unless you're using a native cross compiler(eg. Clang, Golang Compiler), to cross-compile a program, you need to separately build and install a complete gcc+binutils toolchain for every individual arch that you want to target.
-   Which Go this is easy(cross compiler out of the box) + dependencies ensured to support.


#### Cross compilation and CGO {#cross-compilation-and-cgo}

If you need to cross-compile go code with `CGO`, you cross-compiling C compiler for the target machine. It can be done but it is a bit of PITA.

<!--list-separator-->

-  Using Zig

    ```shell
    CGO_ENABLED=1 GOOS=linux GOARCH=amd64 CC="zig cc -target x86_64-linux" CXX="zig c++ -target x86_64-linux" go build --tags extended
    ```

<!--list-separator-->

-  Other

    -   You need a target gcc and target libraries
    -   Compiling in VPS's of each architecture.
    -   Compile directly to the target os/arch when I need cgo support


## Random Guidelines {#random-guidelines}

-   The **name** of a variable, or a constant, should describe its purpose.
-   **Comments** on variables and constants should describe their contents not their purpose.
-   Name your package for what it provides, not what it contains.
-   **guard clauses**; conditional blocks with assert preconditions upon entering a function. return early.
-   If you assign nil to a slice and the slice will have zero len and zero cap and no longer point an underlying array.
-   global variables become an invisible parameter to every function in your program! Any function that relies on the state of a global variable can be broken if another part of the program changes that variable.
-   Go features first class support for concurrency with channels, and the select and go statements.
-   Channels orchestrate; mutexes serialize.
-   Always close channels from sending side.
-   Go maps are sort of live in the heap or something ([Full details here](https://dave.cheney.net/2018/05/29/how-the-go-runtime-implements-maps-efficiently-without-generics)), so if you want to keep the pointer to the slice or other stuff you gotta do what you gotta do.


## Conversations {#conversations}

-   `./…`: An import path is a pattern if it includes one or more "..." wildcards, each of which can match any string. Example: `x/...` matches `x` as well as `x`'s subdirectories.
-   About `Context.context`: I had a [conversation on slack about `Contexts`](https://gophers.slack.com/archives/C02A8LZKT/p1588549175026200). It's not possible for a function that takes a `context.Context` and cancel it. All it could do is `newCtx, cancel :` context.WithCancel(origCtx)=. In that case, when `cancel()` is called `newCtx` will be canceled, but `origCtx` will not. Additionally, when you're passing context to a some function; the original context can be used to cancel the request early. The provided context can't be cancelled by the HTTP client. `newCtx` will be canceled either when `cancel()` is called or `origCtx` is canceled, so in a manner of speaking it inherits from it. It will also have access to the same values as `origCtx` does.
-   More on context: [Break The Golang Context Chain » Rodaine](https://rodaine.com/2020/07/break-context-cancellation-chain/)
-   Even more: [Chris's Wiki blog/programming/GoContextValueMistake](https://utcc.utoronto.ca/~cks/space/blog/programming/GoContextValueMistake)


## Resources and Links {#resources-and-links}

-   [Go: Should I Use a Pointer instead of a Copy of my Struct?](https://medium.com/a-journey-with-go/go-should-i-use-a-pointer-instead-of-a-copy-of-my-struct-44b43b104963)
-   [The Within Go Repo Layout - Xe Iaso](https://christine.website/blog/within-go-repo-layout-2020-09-07)
-   [A few bytes here, a few there, pretty soon you’re talking real memory | Dave Cheney](https://dave.cheney.net/2021/01/05/a-few-bytes-here-a-few-there-pretty-soon-youre-talking-real-memory)
-   [Practical Go: Real world advice for writing maintainable Go programs](https://dave.cheney.net/practical-go/presentations/gophercon-singapore-2019.html)
